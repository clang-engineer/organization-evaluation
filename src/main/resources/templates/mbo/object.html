<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layout/layoutMBO}">
<!-- div content -->
<div layout:fragment="content">
    <!-- Page Content -->
    <div class="container">
        <!-- Page Heading/Breadcrumbs -->
        <h2 class="mb-4">MBO List
            <small>Subheading</small>
        </h2>

        <div th:if="${turn.infoMBO.status}!='see'">
            <!-- <button th:if="${session.evaluator.sno}==${sno}" id="addObject" class="btn float-right" type="submit"><i class="fas fa-plus-circle">목표추가</i></button> -->
            <button id="addObject" class="btn float-right" type="submit"><i class="fas fa-plus-circle">목표추가</i></button>
        </div>
        <table class="table" id="objectListTable">
            <thead class="thead-dark">
                <th class="text-nowrap" style="width: 5%" scope="col">#</th>
                <th class="text-nowrap" style="width: 40%" scope="col">목표</th>
                <th class="text-nowrap" style="width: 40%" scope="col">달성기준</th>
                <th class="text-nowrap" style="width: 2%" scope="col">비중%</th>
                <th class="text-nowrap" style="width: 2%" scope="col" th:if="${turn.infoMBO.status}!='see'">수정</th>
                <th class="text-nowrap" style="width: 10%" scope="col" th:if="${turn.infoMBO.status}=='see'">본인평가</th>
                <th class="text-nowrap" style="width: 10%" scope="col" th:if="${turn.infoMBO.status}=='see' and ${relation.relation}!='me'">상사평가</th>
                <th class="text-nowrap" style="width: 2%" scope="col">댓글</th>
            </thead>
            <tbody>
                <div th:each="object,status:${objectList}" th:if="${object.finish}=='Y'">

                    <!-- object -->
                    <tr>
                        <th name="objectCount" scope="row" style="line-height:150px;">[[${status.count}]]</th>
                        <!-- <th scope="row" style="line-height:150px;">[[${object.mno}]]</th> -->
                        <td class="text-left" style="white-space:pre-line">[[${object?.object}]]</td>
                        <td class="text-left" style="white-space:pre-line">[[${object?.process}]]</td>
                        <td class="ratio align-middle">[[${#numbers.formatPercent(object.ratio,0,0)}]]</td>
                        <td class="align-middle text-middle"  th:if="${turn.infoMBO.status}!='see'">
                            <button class="btn btn-default btn-lg modifyObject" th:data-mno="${object.mno}"><i class="fas fa-eraser"></i></button>
                        </td>
                        <!-- 본인평가 -->
                        <td class="align-middle text-middle" th:if="${turn.infoMBO.status}=='see'">
                            <select class="form-control" th:name="${status.count}" th:disabled="${relation.relation}!='me'">
                                <option value="">--</option>
                                <option th:each="reply:${replyCodeList}" th:value="${reply.ratio}">
                                    [[${reply.name}]]
                                </option>
                            </select>
                        </td>
                        <!-- 상사평가 -->
                        <td class="align-middle text-middle" th:if="${turn.infoMBO.status}=='see' and ${relation.relation}!='me'">
                            <select class="form-control" th:name="${status.count}">
                                <option value="">--</option>
                                <option th:each="reply:${replyCodeList}" th:value="${reply.ratio}">
                                    [[${reply.name}]]
                                </option>
                            </select>
                        </td>
                        <!-- 댓글 collapse -->
                        <td class="align-middle text-middle">
                            <button class="btn btn-default btn-lg" data-toggle="collapse" th:href="'#collapse' +${object.mno}" role="button" aria-expanded="false" aria-controls="collapseExample">
                                <i class="fas fa-comments"></i>
                            </button>
                        </td>
                    </tr>
                    <!-- ./object -->
                    <!-- reply -->
                    <tr th:each="reply:${replyList}" th:if="${reply.mno}==${object.mno}" class="collapse" th:id="collapse+${object.mno}">
                        <td>
                            <div class="collapse" th:id="collapse+${object.mno}">
                                <i class="fas fa-comment-dots fa-flip-horizontal"></i>
                            </div>
                        </td>
                        <td th:colspan="${turn.infoMBO.status}!='see'?'4':'6'" class="text-left">
                            <div class="collapse" th:id="collapse+${object.mno}">
                                [[${reply.rno}]]
                                [[${reply?.comment}]]
                                <!-- 본인이면 아이디 안 붙도록 -->
                                <div class="float-right">[[${reply.updateId}]] - [[${#dates.format(reply.updateDate, 'yy/MM/dd HH:mm')}]]</div>
                            </div>
                        </td>
                        <td th:if="${turn.infoMBO.status}!='see'">
                            <button type="button" th:data-rno="${reply.rno}" class="btn btn-default btn-sm replyModify"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                    <tr class="collapse table-primary" th:id="collapse+${object.mno}" th:if="${turn.infoMBO.status}!='see'">
                        <td colspan=5 class="align-middle text-middle">
                            <div class="form-group">
                                <input type="text" class="form-control form-inline" placeholder="Enter Reply">
                            </div>
                        </td>
                        <td>
                            <button type="button" th:data-mno="${object.mno}" class="btn btn-primary btn-sm replyRegister">등록</button>
                        </td>
                    </tr>
                    <!-- ./reply -->
                </div>
                        <div th:each="object,status:${removedList}">
                            [[${object?.object}+${object.finish}]]
                        </div>
            </tbody>
        </table>

    </div>
       <!-- button -->
       <div id="bottomGroup" class="position-fixed" align="center">
        <div id="bottomBtn" class="btn-group btn-group btn-group-lg">
            <button th:if="${turn.infoMBO.status}=='see' AND ${relation?.finish}!='Y'" id="btnSubmit" type="submit" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="최종 제출"><i class="fas fa-share fa-2x"></i>
                <div>Submit</div>
            </button>
            <button th:if="${turn.infoMBO.status}=='see' AND ${relation?.finish}!='Y'" id="btnPause" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="임시 저장"><i class="fas fa-pause-circle fa-2x"></i>
                <div>Pause</div>
            </button>
            <button id="top" class="btn btn-default"><i class="fas fa-arrow-alt-circle-up fa-2x"></i>
                <div>Top</div>
            </button>
        </div>
        <div>
            <span th:if="${relation?.relation}!='me'" class="badge badge-pill badge-warning">'[[${relation?.evaluated?.name}]]'님 목표 관리</span>
            <span th:if="${relation?.relation}=='me'" class="badge badge-pill badge-warning">'[[${relation?.evaluated?.name}]]'님 본인 목표 관리</span>
        </div>
    </div>
    <!-- button -->
    
    <!-- ./Page Content -->
    <div th:insert="~{common/modal::object}"></div>
    <div th:insert="~{common/modal::basic}"></div>
</div>

</html>
<th:block layout:fragment="script">
    <script type="text/javascript" src="/public/js/object.js"></script>
    <script type="text/javascript" src="/public/js/reply.js"></script>
    <script th:inline="javascript">
        $(document).ready(function (e) {

            var csrf = JSON.parse('[[${_csrf}]]');

            //modal 사용 변수 선언
            var modal = $("#objectModal");
            var modalTitle = modal.find("#modalTitle");
            var modalBody = modal.find("#modalBody");
            var modalLabel1 = modal.find("#modalLabel1");
            var modalLabel2 = modal.find("#modalLabel2");
            var modalLabel3 = modal.find("#modalLabel3");
            var modalContent1 = modal.find("textarea[name='modalContent1']");
            var modalContent2 = modal.find("textarea[name='modalContent2']");
            var modalContent3 = modal.find("select[name='modalContent3']");
            var modalGroupContent1 = modal.find("#content1");
            var modalGroupContent2 = modal.find("#content2");
            var modalModifyBtn = modal.find("#modalModifyBtn");
            var modalRemoveBtn = modal.find("#modalRemoveBtn");
            var modalRegisterBtn = modal.find("#modalRegisterBtn");
            var modalCloseBtn = modal.find("#modalCloseBtn");

            modalTitle.text("Object Register");
            modalLabel1.text("목표");
            modalLabel2.text("달성기준");
            modalLabel3.text("비중");

            //테이블 지정
            var objectListTable = $('#objectListTable');

            //modal select 초기화
            function modalSelectInit(now) {
                modalContent3.html("");
                var sum = 0;
                $('tr').children('.ratio').each(function () {
                    var value = parseInt($(this).text());
                    sum = (value > 0) ? sum + value : sum + 0;
                });
                console.log(sum);
                sum = 100 - sum;
                if (now != null) {
                    sum = sum + now;
                }
                var num = sum / 5;
                var str;
                for (var i = 0; i <= num; i++) {
                    str += "<option value='" + 0.05 * i + "'>" + Math.floor(0.05 * i * 100) + "%</option>";
                }
                modalContent3.html(str);
            }

            //목표 추가 버튼 누 눌렀을 때
            $("#addObject").click(function (e) {
                //select 초기화
                modalSelectInit();

                //모달 text
                modalContent1.val("");
                modalContent2.val("");
                modalContent3.val("0");

                //모달 button
                modal.find("button[id!='modalCloseBtn']").hide();
                modalRegisterBtn.show();

                modal.modal("show");
            });

            var tno = [[${ tno }]];
            var sno = [[${ relation.evaluated.sno }]];
            var sessionId = [[${ session.evaluator.email }]];

            modalRegisterBtn.click(function (e) {
                var param = {
                    tno: tno,
                    sno: sno,
                    object: modalContent1.val(),
                    process: modalContent2.val(),
                    ratio: modalContent3.val(),
                    writeId: sessionId,
                    updateId: sessionId,
                    finish: 'Y',
                    csrf: csrf
                }

                objectService.register(param, function (result) {
                    //인덱스의 최대값 찾기.
                    var max = 0;
                    // $('tr').children('th').each(function () {
                    $("th[name='objectCount']").each(function () {
                        var value = parseInt($(this).text());
                        max = (value > max) ? value : max;
                    });

                    //목표 행 생성.
                    var str = "<tr><th name='objectCount' scope='row' style='line-height:150px;'>" + (max + 1) + "</th>"
                        + "<td class='text-left' style = 'white-space:pre-line'>" + result.object + "</td >"
                        + "<td class='text-left' style='white-space:pre-line'>" + result.process + "</td>"
                        + "<td class='ratio align-middle' >" + Math.floor(result.ratio * 100) + '%' + "</td >"
                        + "<td class='align-middle text-middle' ><button class='btn btn-default btn-lg modifyObject' data-mno='" + result.mno + "' ><i class='fas fa-eraser'></i></button></td >"
                        + "<td class='align-middle text-middle'><button class='btn btn-default btn-lg' data-toggle='collapse' href='#collapse" + result.mno + "' role='button' aria-expanded='false' aria-controls='collapseExample'><i class='fas fa-comments'></i></button></td >"
                        + "</tr >"
                        + "<tr class='collapse' id='collapse" + result.mno + "'><td colspan='5' class='align-middle text-middle'><div class='form-group'><input type='text' class='form-control form-inline' placeholder='Enter Reply'></div></td>"
                        + "<td><button type='button' data-mno='" + result.mno + "' class='btn btn-primary btn-sm replyRegister'>등록</button></td>"
                        + "</tr>;"

                    objectListTable.append(str);

                    //모달 text 초기화
                    modal.find("input").val("");

                    modal.modal('hide');
                    alert("정상적으로 등록되었습니다.");
                });
            });

            //테이블 내의 각 목표 행 modify 클릭 했을 때
            objectListTable.on("click", ".modifyObject", function (e) {
                //data 불러오기
                var mno = $(this).data("mno");

                var param = {
                    mno: mno
                }

                //ajax 호출
                objectService.read(param, function (result) {
                    modalSelectInit(result.ratio * 100);
                    modalContent1.val(result.object);
                    modalContent2.val(result.process);
                    modalContent3.val(result.ratio);
                });

                //모달 data 설정
                modal.data("mno", mno);

                // 모달 button
                modal.find("button[id!='modalCloseBtn']").hide();
                modalModifyBtn.show();
                modalRemoveBtn.show();

                modal.modal("show");
            });

            //모달 내의 목표 수정 버튼 클릭 했을 때
            modalModifyBtn.click(function (e) {
                var mno = modal.data("mno");
                var step = [[${ turn.infoMBO.status }]];

                //변수 넘길 때 목표관련 데이터 외에 step을 같이 넘겨서 스텝에 따른 동작 다르게
                var param = {
                    mno: mno,
                    object: modalContent1.val(),
                    process: modalContent2.val(),
                    ratio: modalContent3.val(),
                    updateId: sessionId,
                    step: step,
                    csrf: csrf
                }

                //ajax 호출
                objectService.modify(param, function (result) {
                    alert("수정 되었습니다.");

                    objectListTable.find("button[data-mno=" + mno + "]").parent().parent().find('td').eq(0).text(modalContent1.val());
                    objectListTable.find("button[data-mno=" + mno + "]").parent().parent().find('td').eq(1).text(modalContent2.val());
                    objectListTable.find("button[data-mno=" + mno + "]").parent().parent().find('td').eq(2).text(Math.floor(modalContent3.val() * 100) + '%');
                    modal.modal("hide");
                });
            });

            //모달 내의 삭제 머튼 눌렀을 때
            modalRemoveBtn.click(function (e) {
                var mno = modal.data("mno");
                var step = [[${ turn.infoMBO.status }]];

                //변수 넘길 때 목표관련 데이터 외에 step을 같이 넘겨서 스텝에 따른 동작 다르게
                var param = {
                    mno: mno,
                    step: step,
                    csrf: csrf
                }

                //ajax 호출
                if (delchk() == true) {
                    objectService.remove(param, function (result) {
                        alert("삭제 되었습니다.");
                        objectListTable.find("button[data-mno=" + mno + "]").parent().parent().remove();
                        objectListTable.find("tr[id='collapse" + mno + "']").remove();
                        modal.modal("hide");
                    });
                } else {
                    return;
                };
            });


            // 댓글 등록 버튼 클릭했을 때 등록하기
            objectListTable.on("click", ".replyRegister", function (e) {
                var mno = $(this).data("mno");
                var comment = $(this).parent().parent().find("input").val();

                var param = {
                    sno: sno,
                    mno: mno,
                    comment: comment,
                    writeId: sessionId,
                    updateId: sessionId,
                    csrf: csrf
                }

                //ajax 호출
                replyService.register(param, function (result) {
                    alert("정상적으로 등록되었습니다.");
                    modal.find("input").val("");
                    var currentDate = new Date(result.writeDate);
                    var str = "<tr class='collapse show' id='collapse" + mno + "'><td><div class='collapse show' th:id='collapse" + mno + "'><i class='fas fa-comment-dots fa-flip-horizontal'></i></div></td>"
                        + "<td colspan='4' class='text-left'><div class='collapse show' id='collapse" + mno + "'>" + result.comment + "<div class='float-right'>" + result.updateId + " - " + displayTime(currentDate) + "</div></div></td>"
                        + "<td><button type='button' data-rno='" + result.rno + "' class='btn btn-default btn-sm replyModify'><i class='fas fa-times'></i></button></td ></tr >";

                    objectListTable.find("tr[id='collapse" + mno + "']").last().before(str);
                    objectListTable.find("tr[id='collapse" + mno + "']").parent().find('input').val('');

                    modal.modal('hide');
                });
            });

            //댓글 수정 버튼 클릭했을 때 읽어오기
            objectListTable.on("click", ".replyModify", function (e) {
                var rno = $(this).data("rno");

                var param = {
                    rno: rno
                }

                //ajax호출
                replyService.read(param, function (result) {
                    $("#basicModal").find("input[name='modalContent1']").val(result.comment);
                });

                //모달 value
                $("#basicModal").data("rno", rno);
                $("#basicModal").find("input[name='modalContent2']").attr("readonly", "true").val(sessionId);

                //모달 text
                $("#basicModal").find("#modalTitle").text("Reply Modify/Delete");
                $("#basicModal").find("#modalLabel1").text("Reply");
                $("#basicModal").find("#modalLabel2").text("Replyer");

                //모달 layout
                $("#basicModal").find("button[id!='modalCloseBtn']").hide();
                $("#basicModal").find("#modalModifyBtn").show();
                $("#basicModal").find("#modalRemoveBtn").show();

                $("#basicModal").modal("show");
            });

            // 댓글 모달 내 수정 버튼 클릭 했을 때 수정하기
            $("#basicModal").find("#modalModifyBtn").click(function (e) {
                var rno = $("#basicModal").data("rno");

                var param = {
                    rno: rno,
                    comment: $("#basicModal").find("input[name='modalContent1']").val(),
                    updateId: sessionId,
                    csrf: csrf
                }

                //ajax 호출
                replyService.modify(param, function (result) {
                    alert("수정 되었습니다.");
                    var currentDate = new Date(result.writeDate);
                    var str = "<div class='collpse show' th:id='collapse'" + result.mno + ">"
                        + result.comment + "<div class='float-right'>" + result.updateId + " - " + displayTime(currentDate) + "</div>"
                        + "</div>";

                    objectListTable.find("button[data-rno=" + rno + "]").parent().parent().find('td').eq(1).html(str);

                    $("#basicModal").modal("hide");
                });
            });

            // 댓글 모달 내 삭제 버튼 클릭 했을 때 수정하기
            $("#basicModal").find("#modalRemoveBtn").click(function (e) {
                var rno = $("#basicModal").data("rno");
                var param = {
                    rno: rno,
                    csrf: csrf
                }

                //삭제 여부 한번 더 확인하고 ajax 호출
                if (delchk() == true) {
                    replyService.remove(param, function (result) {
                        alert("삭제 되었습니다.");
                        objectListTable.find("button[data-rno=" + rno + "]").parent().parent().remove();
                        $("#basicModal").modal("hide");
                    });
                } else {
                    return;
                };
            });

            //close button click 시
            modalCloseBtn.on("click", function (e) {
                modal.modal('hide');
            });

            //댓글 모달 close버튼 클릭시
            $("#basicModal").find("#modalCloseBtn").on("click", function (e) {
                $("#basicModal").modal('hide');
            });

            //글자 수 카운터
            modalBody.on("keyup", "textarea", function (e) {
                var length = $(this).val().length;
                $(this).next().html(length + "/1500");
            });


            // load했을 때 버튼 사이즈
            var win = $(this);
            if (win.width() < 768) {
                $('#bottomBtn').addClass('btn-group-sm');
                $('#bottomBtn').removeClass('btn-group-xs');
                $('#bottomBtn').removeClass('btn-group-lg');
                $('#bottomBtn').removeClass('btn-group-xs');
                $('#bottomBtn').removeClass('btn-group-vertical');

            } else if ((win.width() < 1200)) {
                $('#bottomBtn').removeClass('btn-group-sm');
                $('#bottomBtn').addClass('btn-group-xs');
                $('#bottomBtn').removeClass('btn-group-lg');
                $('#bottomBtn').removeClass('btn-group-vertical');

            } else {
                $('#bottomBtn').removeClass('btn-group-sm');
                $('#bottomBtn').removeClass('btn-group-xs');
                $('#bottomBtn').addClass('btn-group-lg');
                $('#bottomBtn').addClass('btn-group-vertical');
            }

            //버튼 크기 조정을 위한 클래스 부여
            $(window).on('resize', function () {
                if (win.width() < 768) {
                    $('#bottomBtn').addClass('btn-group-sm');
                    $('#bottomBtn').removeClass('btn-group-xs');
                    $('#bottomBtn').removeClass('btn-group-lg');
                    $('#bottomBtn').removeClass('btn-group-vertical');

                } else if ((win.width() < 1200)) {
                    $('#bottomBtn').removeClass('btn-group-sm');
                    $('#bottomBtn').addClass('btn-group-xs');
                    $('#bottomBtn').removeClass('btn-group-lg');
                    $('#bottomBtn').removeClass('btn-group-vertical');

                } else {
                    $('#bottomBtn').removeClass('btn-group-sm');
                    $('#bottomBtn').removeClass('btn-group-xs');
                    $('#bottomBtn').addClass('btn-group-lg');
                    $('#bottomBtn').addClass('btn-group-vertical');
                }
            });

            //탑 버튼 나중에 나오도록
            $(window).scroll(function () {
                if ($(this).scrollTop() > 1000) {
                    $('#top').fadeIn();
                } else {
                    $('#top').fadeOut();
                }
            });

            //스크롤 부드럽게 이동
            $('#top').click(function () {
                $('html, body').animate({ scrollTop: 0 }, 400);
                return false;
            });


            //toolitip에 관한 설정
            $('#btnSubmit,#btnPause').tooltip('show');
            //몇초 후에 사라짐
            setTimeout(function () {
                $('#btnSubmit,#btnPause').tooltip('hide');
            }, 2500);

            //delete 체크 함수
            function delchk() {
                if (confirm("삭제하시겠습니까?")) {
                    return true;
                } else {
                    return false;
                }
            }

            //시간 표시 함수
            function displayTime(timeValue) {
                var today = new Date();
                var gap = today.getTime() - timeValue;

                var dateObj = new Date(timeValue);
                var str = "";

                if (gap < (1000 * 60 * 60 * 24)) {
                    var hh = dateObj.getHours();
                    var mi = dateObj.getMinutes();
                    var ss = dateObj.getSeconds();

                    return [(hh > 9 ? '' : '0') + hh, ':', (mi > 9 ? '' : '0') + mi, ':', (ss > 9 ? '' : '0') + ss].join('');
                } else {
                    var yy = dateObj.getFullYear();
                    var mm = dateObj.getMonth() + 1;
                    var dd = dateObj.getDate();

                    return [yy, '/', (mm > 9 ? '' : '0') + mm, '/', (dd > 9 ? '' : '0') + dd].join('');
                }
            };
        });

    </script>
</th:block>