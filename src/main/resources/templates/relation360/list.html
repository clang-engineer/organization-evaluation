<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/layoutDetail}">

<div layout:fragment="content">
    <div class="container-fluid">
        <!-- Breadcrumbs-->
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="#">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Tables</li>
        </ol>

        <!-- DataTables Example -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-table"></i> Relation360 List
            </div>

            <!-- search box -->
            <div class="row" style="margin-top: 20px; margin-left: 7px;">
                <div class="col-md-9">
                    <button id="register" class="btn btn-success">Register</button>
                </div>
                <div class="col-md-3" style="float: right">
                    <div class="input-group">
                        <select class="form-control col-sm-4" id="searchType">
                            <option>---
                                </optinon>
                            <option value="evaluated" th:selected="${pageVO.type}=='evaluated'">evaluated name</option>
                            <option value="evaluator" th:selected="${pageVO.type}=='evaluator'">evaluator name</option>
                        </select>
                        <input type="text" class="col-sm-6 form-control bg-light small" id="searchKeyword" th:value="${pageVO.keyword}" placeholder="Search for...">
                        <div class="input-group-append">
                            <button class="btn btn-default border" id="searchBtn" type="button">
                                <i class="fas fa-search fa-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- /search box -->
            <div class="card-body">
                <div class="table-responsive">
                    <table th:with="idxpageNum=${result.currentPageNum}, result=${result.result}" class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Idx</th>
                                <th>Name</th>
                                <th>Department1</th>
                                <th>Department2</th>
                                <th>Level</th>
                                <th>Division1</th>
                                <th>Division1</th>
                                <th>본인</th>
                                <th>1차</th>
                                <th>2차</th>
                                <th>3차</th>
                                <th>제외</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Idx</th>
                                <th>Name</th>
                                <th>Department1</th>
                                <th>Department2</th>
                                <th>Level</th>
                                <th>Division1</th>
                                <th>Division1</th>
                                <th>본인</th>
                                <th>1차</th>
                                <th>2차</th>
                                <th>3차</th>
                                <th>제외</th>
                            </tr>
                        </tfoot>
                        <tbody>
                            <tr th:each="staff,status:${result.content}">
                                <td>[[${idxpageNum-1}*10+${status.count}]]</td>
                                <td>[[${staff.sno}]]</td>
                                <td>[[${staff.department1}]]</td>
                                <td>[[${staff.department2}]]</td>
                                <td>[[${staff.level}]]</td>
                                <td>[[${staff.division1}]]</td>
                                <td>[[${staff.division2}]]</td>
                                <td>
                                    <span class="evaluatorList" th:each="relation:${relationTable}">
                                        <a th:href="${relation.rno}" data-relation="me" th:if="${staff.sno}==${relation.evaluated.sno} and ${relation.relation}=='me'">
                                            <button class='btn btn-default' type='button'><i class='fas fa-check-circle fa-sm'></i></button>
                                        </a>
                                    </span>
                                </td>
                                <td>
                                    <span class="evaluatorList" th:each="relation:${relationTable}">
                                        <a th:href="${relation.rno}" data-relation="1" th:if="${staff.sno}==${relation.evaluated.sno} and ${relation.relation}=='1'">
                                            [[${relation.evaluator.sno}]],
                                        </a>
                                    </span>
                                    <button class="btn btn-default staffForEvaluator" th:attr="data-evaluated=${staff.sno}, data-relation='1'" type="button">
                                        <i class="fas fa-user-plus fa-sm"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="evaluatorList" th:each="relation:${relationTable}">
                                        <a th:href="${relation.rno}" data-relation="2" th:if="${staff.sno}==${relation.evaluated.sno} and ${relation.relation}=='2'">
                                            [[${relation.evaluator.sno}]],
                                        </a>
                                    </span>
                                    <button class="btn btn-default staffForEvaluator" th:attr="data-evaluated=${staff.sno}, data-relation='2'" type="button">
                                        <i class="fas fa-user-plus fa-sm"></i>
                                    </button>
                                </td>
                                <td>
                                    <span class="evaluatorList" th:each="relation:${relationTable}">
                                        <a th:href="${relation.rno}" data-relation="3" th:if="${staff.sno}==${relation.evaluated.sno} and ${relation.relation}=='3'">
                                            [[${relation.evaluator.sno}]],
                                        </a>
                                    </span>
                                    <button class="btn btn-default staffForEvaluator" th:attr="data-evaluated=${staff.sno}, data-relation='3'" type="button">
                                        <i class="fas fa-user-plus fa-sm"></i>
                                    </button>
                                </td>
                                <td><a th:href="${staff.sno}" class="evaluatedInfoDelete">
                                        <button class="btn btn-default" type="button">
                                            <i class="fas fa-trash-alt fa-sm"></i>
                                        </button>
                                    </a></td>
                            </tr>
                        </tbody>
                    </table>

                </div>
                <!-- page nation -->
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-end">
                        <li class="page-item" th:if="${result.prevPage}">
                            <a class="page-link" th:href="${result.prevPage.pageNumber}+1" tabindex="-1">Prev</a>
                        </li>
                        <li class="page-item" th:classappend="${p.pageNumber==result.currentPageNum-1}?active:'' " th:each="p:${result.pageList}">
                            <a class="page-link" th:href="${p.pageNumber}+1">[[${p.pageNumber}+1]]</a>
                        </li>
                        <li class="page-item" th:if="${result.nextPage}">
                            <a class="page-link" th:href="${result.nextPage.pageNumber}+1">Next</a>
                        </li>
                    </ul>
                </nav>
                <!--/ page nation -->
            </div>
            <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>

        </div>

        <p class="small text-center text-muted my-5">
            <em>More table examples coming soon...</em>
        </p>
    </div>

    <!-- /.container-fluid -->
    <form id="f1" th:action="@{list}" method="get">
        <input type="hidden" name="tno" th:value="${tno}" />
        <input type="hidden" name="page" th:value=${result.currentPageNum} />
        <input type="hidden" name="size" th:value=${result.currentPage.pageSize} />
        <input type="hidden" name="type" th:value=${pageVO.type} />
        <input type="hidden" name="keyword" th:value=${pageVO.keyword} />
    </form>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">relation360</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group"><label>relation360</label>
                        <input type="text" class="form-control" name="modalContent1" value="New Content" readonly>
                    </div>

                    <table class="table table-bordered">
                        <tr>
                            <th>#</th>
                            <th>name</th>
                            <th>id</th>
                            <th>department1</th>
                            <th>department2</th>
                            <th>level</th>
                        </tr>
                        <tbody id="radioBody">
                        </tbody>
                    </table>

                    <!-- <div class="form-group">
						<label>relation3602</label>
						<input class="form-control" name="modalContent2" value="New Content">
					</div> -->
                </div>
                <div class="modal-footer">
                    <button id="modalModifyBtn" type="button" class="btn btn-warning">Modify</button>
                    <button id="modalRemoveBtn" type="button" class="btn btn-danger">Remove</button>
                    <button id="modalRegisterBtn" type="button" class="btn btn-primary">Register</button>
                    <button id="modalCloseBtn" type="button" class="btn btn-default border">Close</button>
                </div>

            </div>
        </div>
    </div>
    <!-- ./Modal -->


</div>




<th:block layout:fragment="script">
    <script type="text/javascript" src="/public/js/relation.js"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            //modal 사용 변수 선언
            var modal = $("#myModal");
            var modalContent1 = modal.find("input[name='modalContent1']");
            // var modalContent2 = modal.find("input[name='modalContent2']");
            var modalModifyBtn = $("#modalModifyBtn");
            var modalRemoveBtn = $("#modalRemoveBtn");
            var modalRegisterBtn = $("#modalRegisterBtn");
            var modalCloseBtn = $("#modalCloseBtn");

            // var cno = [[${ cno }]];
            var tno = [[${ tno }]];
            var msg = [[${ msg }]];

            if (history.state == null) {
                if (msg == 'register') {
                    alert("등록 되었습니다.");
                } else if (msg == 'modify') {
                    alert("수정 되었습니다.");
                } else if (msg == 'remove') {
                    alert("삭제 되었습니다.");
                }
            }

            history.replaceState({}, null, null);

            var formObj = $("#f1");

            //페이지에 붙은 링크 클릭 시
            $(".pagination a").click(function (e) {
                e.preventDefault();

                formObj.find('[name="page"]').val($(this).attr('href'));
                formObj.submit();
            });

            //검색 버튼 클릭 시
            $("#searchBtn").click(function (e) {
                var typeStr = $("#searchType").find(":selected").val();
                var keywordStr = $("#searchKeyword").val();

                formObj.find("[name='type']").val(typeStr);
                formObj.find("[name='keyword']").val(keywordStr);
                formObj.find("[name='page']").val("1");
                formObj.submit();
            });

            //행 삭제 버튼 클릭 시
            $(".evaluatedInfoDelete").click(function (e) {
                e.preventDefault();
                evaluatedNo = $(this).attr("href");
                content = $(this).closest("tr").children().eq(1).text();
                // lev2 = $(this).closest("tr").children().eq(2).text();
                modalContent1.val("피평가자 '" + content + "'의 평가 정보를 모두 삭제합니다.");
                // modalContent2.val(lev2);
                modal.data("idx", evaluatedNo);
                modal.data("delete", "row");

                modal.find("button[id!='modalCloseBtn']").hide();
                modal.find(":text").show();
                modal.find("table").hide();
                modalRemoveBtn.show();

                $(".modal-dialog").removeClass("modal-xl");
                $(".modal-content, .modal-dialog, .modal-body").removeAttr("style");
                $("#myModal").modal("show");
            });

            //피평가자 등록 버튼 클릭 시
            $("#register").click(function (e) {
                e.preventDefault();

                modal.data("type", "evaluated");

                $(".modal-dialog").addClass("modal-xl");
                $(".modal-content, .modal-dialog").css("height", "80%");
                $(".modal-body").css("overflow-y", "scroll").css("max-height", "calc(100% - 120px)");

                modal.find("table").show();

                showEvaluatedList(tno);

                modal.find(":text").hide();
                modal.find("button[id!='modalCloseBtn']").hide();
                modalRegisterBtn.show();
                $("#myModal").modal("show");
            });

            //평가자 등록 버튼 클릭 시
            $(".staffForEvaluator").click(function (e) {
                e.preventDefault();

                $(".modal-dialog").addClass("modal-xl");
                $(".modal-content, .modal-dialog").css("height", "80%");
                $(".modal-body").css("overflow-y", "scroll").css("max-height", "calc(100% - 120px)");

                modal.data("type", "evaluator");
                modal.data("evaluated", $(this).data("evaluated"));
                modal.data("relation", $(this).data("relation"));

                modal.find("table").show();
                var sno = $(this).data("evaluated");
                showEvaluatorList({ tno: tno, sno: sno });

                modal.find(":text").hide();
                modal.find("button[id!='modalCloseBtn']").hide();
                modalRegisterBtn.show();
                $("#myModal").modal("show");
            });

            //modal내의 register 클릭 시
            modalRegisterBtn.on("click", function () {
                if (modal.data("type") == "evaluated") {
                    var evaluated = $(":input:radio[name=evaluated]:checked").val();
                    var evaluator = $(":input:radio[name=evaluated]:checked").val();
                    var relation = "me";
                } else if (modal.data("type") == "evaluator") {
                    var evaluator = $(":input:radio[name=evaluator]:checked").val();
                    var evaluated = modal.data("evaluated");
                    var relation = modal.data("relation");
                }

                formObj.attr("action", "./register").attr("method", "post");
                // formObj.append("<input type='hidden' name='content' value='" + modalContent1.val() + "'/>");
                formObj.append("<input type='hidden' name='evaluated' value='" + evaluated + "'/>");
                formObj.append("<input type='hidden' name='evaluator' value='" + evaluator + "'/>");
                formObj.append("<input type='hidden' name='relation' value='" + relation + "'/>");
                console.log(evaluated + "/" + evaluator + "/" + relation);
                // formObj.append("<input type='hidden' name='relation3602' value='" + modalContent2.val() + "'/>");
                formObj.submit();
            });

            //모달 내의 수정 버튼 클릭 시..
            modalModifyBtn.on("click", function (e) {
                formObj.attr("action", "./modify").attr("method", "post");
                formObj.append("<input type='hidden' name='content' value='" + modalContent1.val() + "'/>");
                // formObj.append("<input type='hidden' name='relation3602' value='" + modalContent2.val() + "'/>");
                formObj.append("<input type='hidden' name='lno' value='" + modal.data("idx") + "'/>");
                formObj.submit();
            });


            //모달 내의 삭제 버튼 클릭 시
            modalRemoveBtn.on("click", function (e) {
                if (delchk() == true) {
                    formObj.attr("action", "delete");
                } else {
                    return;
                };

                if (modal.data("delete") == "column") {
                    console.log("column");
                    formObj.attr("action", "./remove").attr("method", "post");
                    formObj.append("<input type='hidden' name='rno' value='" + modal.data("idx") + "'/>");
                } else if (modal.data("delete") == "row") {
                    console.log("row");
                    formObj.attr("action", "./removeRow").attr("method", "post");
                    formObj.append("<input type='hidden' name='sno' value='" + modal.data("idx") + "'/>");
                }
                formObj.submit();
            });

            //close button click 시
            modalCloseBtn.on("click", function (e) {
                modal.modal('hide');
            });

            function delchk() {
                if (confirm("삭제하시겠습니까?")) {
                    return true;
                } else {
                    return false;
                }
            }

            //평가자 리스트에 붙은 링크 클릭 시
            $(".evaluatorList a").click(function (e) {
                e.preventDefault();
                relationNo = $(this).attr("href");
                contentTrim = $.trim($(this).text());
                content = contentTrim.substring(0, contentTrim.length - 1);

                var relation = $(this).data("relation");

                $(".modal-dialog").removeClass("modal-xl");
                $(".modal-content, .modal-dialog, .modal-body").removeAttr("style");

                modal.find(":text").show();
                modal.find("table").hide();

                if (relation == "me") {
                    modalContent1.val("본인 평가 정보를 삭제 합니다.");
                } else {
                    modalContent1.val("평가자 '" + content + "'의 정보를 삭제 합니다.");
                }
                modal.data("idx", relationNo);
                modal.data("delete", "column");

                modal.find("button[id!='modalCloseBtn']").hide();
                modalRemoveBtn.show();

                $("#myModal").modal("show");
            });

            function showEvaluatedList(tno) {
                relationService.getEvaluatedList(tno, function (list) {
                    var str = "";
                    if (list == null || list.length == 0) {
                        $("#radioBody").html("");
                        return;
                    }
                    for (var i = 0, len = list.length || 0; i < len; i++) {
                        str += "<tr><td><input type='radio' name='evaluated' value='" + list[i].sno + "'></td>";
                        str += "<td>" + list[i].sno + "</td>";
                        str += "<td>" + list[i].id + "</td>";
                        str += "<td>" + list[i].department1 + "</td>";
                        str += "<td>" + list[i].department2 + "</td>";
                        str += "<td>" + list[i].level + "</td></tr>";
                    }
                    $("#radioBody").html(str);
                });
            }

            function showEvaluatorList(param) {
                relationService.getEvaluatorList(param, function (list) {
                    var str = "";
                    if (list == null || list.length == 0) {
                        $("#radioBody").html("");
                        return;
                    }
                    for (var i = 0, len = list.length || 0; i < len; i++) {
                        str += "<tr><td><input type='radio' name='evaluator' value='" + list[i].sno + "'></td>";
                        str += "<td>" + list[i].sno + "</td>";
                        str += "<td>" + list[i].id + "</td>";
                        str += "<td>" + list[i].department1 + "</td>";
                        str += "<td>" + list[i].department2 + "</td>";
                        str += "<td>" + list[i].level + "</td></tr>";
                    }
                    $("#radioBody").html(str);
                });
            }
        });
    </script>
</th:block>