<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/layoutCompany}">
<div layout:fragment="content">
	<!-- Begin Page Content -->
	<div class="container-fluid">
		<h1 class="mt-4">Turn List</h1>
		<!-- Page Heading -->
		<p class="mb-4">
			DataTables is a third party plugin that is used to generate the demo table below. For more information about DataTables, please visit the
			<a target="_blank" href="https://datatables.net">official DataTables documentation</a>
		</p>

		<!-- DataTales Example -->
		<div class="card shadow mb-4">
			<div class="card-header py-3">
				<h4 class="m-0 font-weight-bold text-primary" style="display: inline">Turn Tables</h4>
				<div class="col-md-1" style="float: right">
					<button type="button" id="addTurnBtn" class="btn btn-primary btn-block">Add Turn</button>
				</div>
			</div>
			<div class="card-body">

				<div class="table-responsive">
					<table class="table table table-striped table-bordered" id="dataTable" width="100%" cellspacing="0">

						<thead>
							<tr>
								<th>#No</th>
								<th>Title</th>
								<th>Turn Type</th>
								<th>Write Date</th>
								<th>Update Date</th>
								<th>User Page</th>
								<th>Turn Detail</th>
							</tr>
						</thead>
						<tbody id="turnTable">
						</tbody>
					</table>

				</div>
			</div>
		</div>

	</div>

	<form id="f1" th:action="@{list}" method="get">
		<input type="hidden" name="page" th:value=${pageVO.page} />
		<input type="hidden" name="size" th:value=${pageVO.size} />
		<input type="hidden" name="type" th:value=${pageVO.type} />
		<input type="hidden" name="keyword" th:value=${pageVO.keyword} />
	</form>

	<!-- modal -->
	<div id="myModal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Modal Header</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="">Turn Title</label>
						<input type="text" class="form-control" name="turnTitle" />
					</div>
					<div class="form-group">
						<label for="">Turn Type</label>
						<div class="checkbox">
							<label class="checkbox-inline">
								<input type="checkbox" id="checkbox1" name="turnType" value="360"> 360 Survey
							</label> &nbsp;
							<label class="checkbox-inline">
								<input type="checkbox" id="checkbox2" name="turnType" value="MBO"> MBO
							</label>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button id="modalBtn" class="btn btn-info">Save</button>
					<span th:if="(${vo.writeId} eq ${#authentication.name}) or ${#authorization.expression('hasRole(''ADMIN'')')}">
							<button id="delModalBtn" class="btn btn-danger">Delete</button>
						</span>
					<button id="modalCloseBtn" type="button" class="btn btn-default border" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<!-- /.modal -->



	<!-- /.container-fluid -->
</div>

<th:block layout:fragment="script">
	<script th:inline="javascript" th:src="@{'/public/js/turn.js'}"></script>
	<script th:inline="javascript">
		$(document).ready(function (e) {

			var cno = '[[${cno}]]';
			var tno;
			var csrf = JSON.parse('[[${_csrf}]]');

			/* turn list 출력 */
			(function () {
				turnManager.getAll(cno, printList);
			})();


			function printList(list) {
				var str = "";
				var turnObj;
				for (var i = 0; i < list.length; i++) {
					turnObj = list[i];

					str += "<tr>" +
						"<td>" + (i + 1) + "</td>" +
						"<td>" + turnObj.title + "</td>" +
						"<td>" + turnObj.types + "</td>" +
						"<td>" + formatDate(turnObj.writeDate) + "</td>" +
						"<td>" + formatDate(turnObj.updateDate) + "</td>" +
						"<td><a data-type='survey' href='" + [[${ vo.id }]] + "'><button type='button' class='btn btn-default'><i class='fas fa-users'></i></button></a></td>" +
						"<td><a data-type='detail' href='" + turnObj.tno + "'><button type='button' class='btn btn-default'><i class='fas fa-sitemap'></i></button></a></td>" +
						"</tr>";
				}

				$("#turnTable").html(str);
			}

			/* list에 출력되는 시간 포멧 */
			function formatDate(timeValue) {
				var date = new Date(timeValue);
				var yyyy = date.getFullYear();
				var mm = date.getMonth();
				var dd = date.getDate();

				var hh = date.getHours();
				var mi = date.getMinutes();
				var ss = date.getSeconds();

				var formatedTime = [yyyy, '/', (mm > 9 ? '' : '0') + mm, '/', (dd > 9 ? '' : '0') + dd, ' ', (hh > 9 ? '' : '0') + hh, ':', (mi > 9 ? '' : '0') + mi, ':', (ss > 9 ? '' : '0') + ss].join('');

				return formatedTime;
			}


			/* modal 창 */
			$("#addTurnBtn").on('click', function () {
				turnTitleObj.val('');
				checked_values(false);

				$("#myModal").modal("show");
				$(".modal-title").text("Add Turn");
				mode = "ADD";
			});


			var turnTitleObj = $("input[name='turnTitle']");

			/* add turn */
			$("#modalBtn").click(function () {
				var turnTitle = turnTitleObj.val();
				var cno = '[[${cno}]]';
				var turnType = get_chked_values();

				if (mode == 'ADD') {
					var obj = { title: turnTitle, types: turnType, cno: cno, csrf: csrf };
					turnManager.add(obj, function (list) {
						alert("새로운 회차가 등록 되었습니다.");
						afterAll(list)
					});
				} else if (mode == 'MOD') {
					var obj = { title: turnTitle, types: turnType, cno: cno, tno: tno, csrf: csrf }
					turnManager.update(obj, function (list) {
						alert("회차 정보가 수정되었습니다.");
						afterAll(list);
					});
				};
			});


			/* add시 check box 값 취합 */
			function get_chked_values() {
				var types_array = Array();
				var types_cnt = 0;
				$('input:checkbox[name=turnType]').each(function () {
					if ($(this).is(':checked')) {
						types_array[types_cnt] = $(this).val();
						types_cnt++;
					}
				});

				return types_array;
			}

			function afterAll(list) {
				printList(list);
				$("#myModal").modal("hide");
				turnTitleObj.val('');
				checked_values(false);
			}

			function checked_values(boolean) {
				$('input:checkbox[name=turnType]').each(function () {
					$(this).prop('checked', boolean);
				});
			}

			/* detail 버튼 */
			$("#turnTable").on("click", "a", function (e) {
				if ($(this).data("type") == 'detail') {

					if (confirm("회차 상세 설정 화면으로 이동하시겠습니까?")) {
						e.preventDefault();
						$("#f1").empty();
						$("#f1").attr("action", '/staff/list');
						$("#f1").append("<input type='hidden' name='tno' value='" + $(this).attr('href') + "'/>");
						$("#f1").submit();
					} else {
						return false;
					}
				} else if ($(this).data("type") == 'survey') {
					if (confirm("사용자 서베이 페이지로 이동하시겠습니까?")) {
						e.preventDefault();
						$("#f1").empty();
						$("#f1").attr("action", '/survey/');
						$("#f1").append("<input type='hidden' name='company' value='" + $(this).attr('href') + "'/>");
						$("#f1").submit();
					} else {
						return false;
					}
				}
			});

			/* 행 클릭 시!! modify, delete turn */
			$("#turnTable").on("click", "tr", function (e) {
				var tds = $(this).find('td');
				tno = tds.find('a').last().attr('href');
				turnTitleObj.val(tds[1].innerHTML);
				checked_values(false);

				mode = 'MOD';
				switch (tds[2].innerHTML) {
					case '360':
						$("#checkbox1").prop('checked', true);
						break;
					case 'MBO':
						$("#checkbox2").prop('checked', true);
						break;
					case '360,MBO', 'MBO,360':
						checked_values(true);
				}
				$("#myModal").modal("show");
				$(".modal-title").text("Modify/Delete Turn");

				$("input[name='turnTitle']").focus();

			});

			/* modal 창에서 삭제 버튼 눌렀을 때 동작 */
			$("#delModalBtn").on("click", function () {
				if (delchk() == true) {
					var obj = { cno: cno, tno: tno, csrf: csrf }
					turnManager.remove(obj, function (list) {
						alert("정상적으로 삭제 되었습니다.");
						afterAll(list);
					});
				} else {
					return;
				}
			});

			function delchk() {
				if (confirm("삭제하시겠습니까?")) {
					return true;
				} else {
					return false;
				}
			}


			$("#companyListBtn").on("click", function (e) {
				$("#f1").submit();
			});

			//close button click 시
			$("#modalCloseBtn").on("click", function (e) {
				$("#myModal").modal('hide');
			});

		});


	</script>
</th:block>
</script>
</body>

</html>