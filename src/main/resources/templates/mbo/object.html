<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/layoutMBO}">
<!-- div content -->
<div layout:fragment="content">
    <!-- Page Content -->
    <div class="container">
        <!-- Page Heading/Breadcrumbs -->
        <h2 class="mb-4">Survey List
            <small>Subheading</small>
        </h2>

        <div>
            <button id="addObject" class="btn float-right" type="submit"><i class="fas fa-plus-circle">목표추가</i></button>
        </div>
        <!-- [[${objectList}]] -->

        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th style="width: 5%" scope="col">#</th>
                    <th style="width: 30%" scope="col">목표</th>
                    <th style="width: 50%" scope="col">달성기준</th>
                    <th style="width: 5%" scope="col">비중%</th>
                    <th style="width: 5%" scope="col">수정</th>
                    <th style="width: 5%" scope="col">댓글</th>
                </tr>
            </thead>
            <tbody th:each="object,status:${objectList}">
                <!-- object -->
                <tr>
                    <th scope="row" style="line-height:150px;">[[${status.count}]]</th>
                    <td class="text-left" style="white-space:pre-line">[[${object?.object}]]</td>
                    <td class="text-left" style="white-space:pre-line">[[${object?.process}]]</td>
                    <td class="align-middle">[[${#numbers.formatPercent(object.ratio,0,0)}]]</td>
                    <td class="align-middle text-middle">
                        <button class="btn btn-default btn-lg modifyObject" th:data-mno="${object.mno}" >
                            <i class="fas fa-eraser"></i>
                        </button>   
                    </td>
                    <td class="align-middle text-middle">
                        <button class="btn btn-default btn-lg" data-toggle="collapse" th:href="'#collapse' +${object.mno}" role="button" aria-expanded="false" aria-controls="collapseExample">
                            <i class="fas fa-comment-dots"></i>
                        </button>
                    </td>
                </tr>
                <!-- ./object -->
                <!-- reply -->
                <tr th:each="reply:${replyList}" th:if="${reply.mno}==${object.mno}" class="collapse" th:id="collapse+${object.mno}">
                    <td>
                        <div class="collapse" th:id="collapse+${object.mno}">
                            <i class="fab fa-replyd fa-lg">
                            </i>
                        </div>
                        
                    </td>
                    <td colspan="4" class="text-left">
                        <div class="collapse" th:id="collapse+${object.mno}">
                            [[${reply?.comment}]]
                        </div>
                    </td>
                    <td>
                        [[${reply.updateDate}]]
                        <i class="fas fa-eraser"></i>
                    </td>
                </tr>
                <tr class="collapse" th:id="collapse+${object.mno}">
                    <td colspan="5" class="align-middle text-middle">
                    <div class="form-group">
                        <input type="text" class="form-control form-inline" placeholder="Enter Reply">
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-primary btn-sm">등록</button>
                </td>
                </tr>
                <!-- ./reply -->
            </tbody>
        </table>

    </div>
    <!-- ./Page Content -->


    <!-- Modal -->
    <div class="modal fade" id="contentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle">Title</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;
                    </button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div class="form-group" id="content1">
                        <label class="modal-label" id="modalLabel1">Content1</label>
                        <textarea class="form-control" name="modalContent1" rows="10"></textarea>
                        <p class="float-md-right mb-0" id="count_message">0/1500</p>
                    </div>
                    <div class="form-group" id="content2">
                        <label class="modal-label" id="modalLabel2">Content2</label>
                        <textarea class="form-control" name="modalContent2" rows="10"></textarea>
                        <p class="float-md-right mb-0" id="count_message">0/1500</p>
                    </div>
                    <div class="form-group" id="content3">
                        <label class="modal-label" id="modalLabel3">Content3</label>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <button class="btn btn-outline-secondary" type="button">Button</button>
                            </div>
                            <select class="custom-select" name="modalContent3">
                                <option selected>Choose...</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.05">5%</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="modalModifyBtn" type="button" class="btn btn-warning">Modify</button>
                    <button id="modalRemoveBtn" type="button" class="btn btn-danger">Remove</button>
                    <button id="modalRegisterBtn" type="button" class="btn btn-primary">Register</button>
                    <button id="modalCloseBtn" type="button" class="btn btn-default border">Close</button>
                </div>

            </div>
        </div>
    </div>
    <!-- Modal -->

</div>

</html>
<th:block layout:fragment="script">
    <script type="text/javascript" src="/public/js/object.js"></script>
    <script th:inline="javascript">
        $(document).ready(function (e) {
            var csrf = JSON.parse('[[${_csrf}]]');

            //modal 사용 변수 선언
            var modal = $("#contentModal");
            var modalTitle = modal.find("#modalTitle");
            var modalBody = modal.find("#modalBody");
            var modalLabel1 = modal.find("#modalLabel1");
            var modalLabel2 = modal.find("#modalLabel2");
            var modalLabel3 = modal.find("#modalLabel3");
            var modalContent1 = modal.find("textarea[name='modalContent1']");
            var modalContent2 = modal.find("textarea[name='modalContent2']");
            var modalContent3 = modal.find("select[name='modalContent3']");
            var modalGroupContent1 = modal.find("#content1");
            var modalGroupContent2 = modal.find("#content2");
            var modalModifyBtn = modal.find("#modalModifyBtn");
            var modalRemoveBtn = modal.find("#modalRemoveBtn");
            var modalRegisterBtn = modal.find("#modalRegisterBtn");
            var modalCloseBtn = modal.find("#modalCloseBtn");

            modalTitle.text("Object Register");
            modalLabel1.text("목표");
            modalLabel2.text("달성기준");
            modalLabel3.text("비중");


            $("#addObject").click(function (e) {
                modal.modal("show");

                //모달 button
                modal.find("button[id!='modalCloseBtn']").hide();
                modalRegisterBtn.show();

            });

            var tno = [[${ tno }]];
            var sno = [[${ session?.evaluator ?.sno }]];

            modalRegisterBtn.click(function (e) {
                var param = {
                    tno: tno,
                    sno: sno,
                    object: modalContent1.val(),
                    process: modalContent2.val(),
                    ratio: modalContent3.val(),
                    writeId: sno,
                    updateId: sno,
                    finish: 'Y',
                    csrf: csrf
                }

                objectService.register(param, function (result) {
                    alert("정상적으로 등록되었습니다.");
                    modal.find("input").val("");
                    modal.modal('hide');
                });
            });

            $("table").on("click", ".modifyObject", function (e) {
                var mno = $(this).data("mno");
                modal.data("mno", mno);

                var param = {
                    mno: mno
                }
                objectService.read(param, function (result) {
                    modalContent1.val(result.object);
                    modalContent2.val(result.process);
                    modalContent3.val(result.ratio);
                });

                // 모달 button
                modal.find("button[id!='modalCloseBtn']").hide();
                modalModifyBtn.show();
                modalRemoveBtn.show();

                modal.modal("show");
            });

            modalModifyBtn.click(function (e) {
                var mno = modal.data("mno");
                var param = {
                    mno: mno,
                    object: modalContent1.val(),
                    process: modalContent2.val(),
                    ratio: modalContent3.val(),
                    csrf: csrf
                }

                objectService.modify(param, function (result) {
                    alert("수정 되었습니다.");
                    modal.modal("hide");
                });
            });

            modalRemoveBtn.click(function (e) {
                var mno = modal.data("mno");
                var param = {
                    mno: mno,
                    csrf: csrf
                }
                
                if (delchk() == true) {
                    objectService.remove(param, function (result) {
                        alert("삭제 되었습니다.");
                        modal.modal("hide");
                    });
                } else {
                    return;
                };
            });

            //close button click 시
            modalCloseBtn.on("click", function (e) {
                modal.modal('hide');
            });

            //글자 수 카운터
            modalBody.on("keyup", "textarea", function (e) {
                var length = $(this).val().length;
                $(this).next().html(length + "/1500");
            });


            function delchk() {
                if (confirm("삭제하시겠습니까?")) {
                    return true;
                } else {
                    return false;
                }
            }
        });

    </script>
</th:block>